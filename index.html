<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Kameraflöde</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <script defer src="main.js"></script>
</head>
<body>
    <div class="menu-container">
        <!-- Flip button moved to dropdown -->
        <button id="rotate-btn" title="Rotera kameran">⟳</button>
        <button id="menu-btn">☰</button>
        <div id="menu-dropdown" class="menu-dropdown">
            <a href="#" id="normal-cam">Vanlig kamera</a>
            <a href="#" id="overall-cam">Overall</a>
            <a href="#" id="outline-bg">Vit outline</a>
            <div style="margin:8px 0 0 0;">
                <label for="grid-res-select" style="color:#fff;">Upplösning:</label>
                <select id="grid-res-select" style="width:100%;margin-top:4px;">
                    <option value="8">8 x 8</option>
                    <option value="16">16 x 16</option>
                    <option value="24">24 x 24</option>
                    <option value="32" selected>32 x 32</option>
                    <option value="48">48 x 48</option>
                    <option value="64">64 x 64</option>
                </select>
            </div>
            <button id="flip-btn" style="width:100%;margin:8px 0 0 0;">Vänd upp/ner ⇵</button>
            <button id="flip-side-btn" style="width:100%;margin:8px 0 0 0;">Vänd sida ⇋</button>
            <div id="outline-options" style="display:none; padding: 8px 0 0 0;">
                <button id="outline-type-dots">Prickar</button>
                <button id="outline-type-grid">Rutnät</button>
                <div style="margin-top:8px; color:#fff;">
                    <label for="dot-spacing-slider">Prick-avstånd:</label>
                    <input type="range" id="dot-spacing-slider" min="1" max="20" value="5" style="vertical-align:middle;">
                    <span id="dot-spacing-value">5</span>
                </div>
            </div>
        </div>
    </div>
    <div id="loader" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:100;align-items:center;justify-content:center;background:rgba(34,34,34,0.8);color:#fff;font-size:2rem;">
        Laddar AI-modell...
    </div>
    <video id="video" autoplay playsinline></video>
    <canvas id="output-canvas" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:2;"></canvas>
    <script>
        let usingBackCamera = false;
        let currentStream = null;
        const videoEl = document.getElementById('video');
        const canvasEl = document.getElementById('output-canvas');
        const rotateBtn = document.getElementById('rotate-btn');
        let flipped = false;
        let flippedSide = false;

        async function startCamera(back = false) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            let constraints = { video: { facingMode: back ? { exact: 'environment' } : 'user' } };
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoEl.srcObject = stream;
                currentStream = stream;
            } catch (err) {
                alert('Kunde inte starta kameran: ' + err.message);
            }
        }

        function updateTransforms() {
            let base = '';
            // Always mirror for selfie/front camera
            if (!usingBackCamera) base += 'scaleX(-1) ';
            if (flipped) base += 'scaleY(-1) ';
            if (flippedSide) base += 'scaleX(-1) ';
            videoEl.style.transform = base.trim();
            canvasEl.style.transform = base.trim();
        }

        startCamera();
        updateTransforms();

        rotateBtn.addEventListener('click', () => {
            usingBackCamera = !usingBackCamera;
            startCamera(usingBackCamera);
        });

        document.getElementById('flip-btn').addEventListener('click', () => {
            flipped = !flipped;
            updateTransforms();
        });
        document.getElementById('flip-side-btn').addEventListener('click', () => {
            flippedSide = !flippedSide;
            updateTransforms();
        });
    </script>
</body>
</html>
